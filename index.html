<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="icon.png">
    <title>RunRecord</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:wght@400;800&family=Markazi+Text:wght@700&family=Fugaz+One&family=Shadows+Into+Light+Two&family=Michroma&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root { --bg-color: #101012; --card-bg: #1c1c1e; --toss-blue: #3182f6; --text-main: #ffffff; --text-sub: #adb5bd; }
        body { background: var(--bg-color); color: var(--text-main); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        #canvas-container { position: relative; width: 340px; height: 604px; background: var(--card-bg); border-radius: 30px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #2c2c2e; margin-top: 10px; }
        canvas { width: 100%; height: 100%; display: block; }
        .controls { margin-top: 20px; width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 50px; }
        .input-group { background: var(--card-bg); padding: 10px 15px; border-radius: 16px; display: flex; flex-direction: column; }
        .input-group label { font-size: 11px; color: var(--text-sub); margin-bottom: 3px; font-weight: 600; }
        select, input { background: transparent; border: none; color: white; font-size: 15px; outline: none; padding: 2px 0; }
        .btn-row { display: flex; gap: 8px; }
        button { flex: 1; border: none; padding: 14px; border-radius: 16px; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; color: white; }
        .align-btn { background: #3a3a3c; padding: 10px; font-size: 12px; }
        .align-btn.active { background: var(--toss-blue); }
        #recordBtn { background: var(--toss-blue); }
        #status { font-size: 11px; color: var(--toss-blue); text-align: center; height: 12px; margin: 5px 0; }
    </style>
</head>
<body>
    <div id="canvas-container"><canvas id="runCanvas"></canvas></div>
    <div class="controls">
        <input type="file" id="imageInput" accept="image/*" style="color: #888; font-size: 12px;">
        <div class="input-group">
            <label>Text Alignment</label>
            <div class="btn-row">
                <button class="align-btn active" onclick="setAlign('left', this)">Left</button>
                <button class="align-btn" onclick="setAlign('center', this)">Center</button>
                <button class="align-btn" onclick="setAlign('right', this)">Right</button>
            </div>
        </div>
        <div class="input-group">
            <label>Font Style</label>
            <select id="fontSelect" onchange="draw(displayData.distance)">
                <option value="-apple-system">San Francisco</option>
                <option value="'Orbitron'">Orbitron (Cyber)</option>
                <option value="'Roboto Flex'">Roboto Flex</option>
                <option value="'Fugaz One'">Fugaz One</option>
                <option value="'Michroma'">Michroma</option>
            </select>
        </div>
        <div class="input-group">
            <label>Distance (KM)</label>
            <input type="number" id="distInput" placeholder="0.00" step="0.01">
        </div>
        <div class="btn-row">
            <div class="input-group" style="flex:1;"><label>Avg. Pace</label><input type="text" id="paceInput" placeholder="555"></div>
            <div class="input-group" style="flex:1;"><label>Time</label><input type="text" id="timeInput" placeholder="000000"></div>
        </div>
        <div id="status"></div>
        <div class="btn-row">
            <button id="previewBtn" style="background:#3a3a3c" onclick="runAnimation(false)">Preview</button>
            <button id="recordBtn" onclick="runAnimation(true)">Create & Save (.mp4)</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('runCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1080; canvas.height = 1920;

    let bgImage = null;
    let displayData = { distance: 0 };
    let textAlign = 'left'; // ê¸°ë³¸ ì •ë ¬ê°’

    function setAlign(align, btn) {
        textAlign = align;
        document.querySelectorAll('.align-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        draw(displayData.distance);
    }

    function formatPace(val) {
        if (!val) return "0'00\"";
        let n = val.replace(/\D/g, '');
        return n.length >= 3 ? `${n.slice(0, n.length-2)}'${n.slice(n.length-2)}"` : n;
    }

    function formatTime(val) {
        if (!val) return "00:00";
        let n = val.replace(/\D/g, '');
        if (n.length === 6) return `${n.slice(0,2)}:${n.slice(2,4)}:${n.slice(4,6)}`;
        return n.length === 4 ? `${n.slice(0,2)}:${n.slice(2,4)}` : val;
    }

    function draw(dist = 0) {
        const font = document.getElementById('fontSelect').value;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. ë°°ê²½ ë° ê·¸ë¼ë°ì´ì…˜ ì„¤ì •
        if (bgImage) {
            const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
            const x = (canvas.width / 2) - (bgImage.width / 2) * scale;
            const y = (canvas.height / 2) - (bgImage.height / 2) * scale;
            ctx.drawImage(bgImage, x, y, bgImage.width * scale, bgImage.height * scale);
            
            let grad;
            if(textAlign === 'center') grad = ctx.createLinearGradient(0, canvas.height, 0, canvas.height * 0.4);
            else if(textAlign === 'left') grad = ctx.createLinearGradient(0, canvas.height, canvas.width * 0.8, canvas.height * 0.4);
            else grad = ctx.createLinearGradient(canvas.width, canvas.height, canvas.width * 0.2, canvas.height * 0.4);
            
            grad.addColorStop(0, "rgba(0,0,0,0.85)");
            grad.addColorStop(1, "rgba(0,0,0,0)");
            ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else {
            ctx.fillStyle = "#1c1c1e"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // 2. ì •ë ¬ ê¸°ì¤€ Xì¢Œí‘œ ì„¤ì •
        let xPos;
        const padding = 100;
        if (textAlign === 'left') xPos = padding;
        else if (textAlign === 'center') xPos = canvas.width / 2;
        else xPos = canvas.width - padding;

        const startY = canvas.height - 620;

        // 3. ê±°ë¦¬(Distance) ì„¹ì…˜ ì²˜ë¦¬
        const dText = dist.toFixed(2);
        const unitText = "km";
        ctx.font = `bold 180px ${font}`;
        const dWidth = ctx.measureText(dText).width;
        ctx.font = `600 60px ${font}`;
        const uWidth = ctx.measureText(unitText).width;
        const spacing = 25;
        const totalDistWidth = dWidth + spacing + uWidth;

        // [Distance ë¼ë²¨ ì •ë ¬]
        ctx.textAlign = textAlign; 
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        ctx.font = `500 40px ${font}`;
        ctx.fillText("Distance", xPos, startY - 175);

        // [ìˆ«ìž + km ë©ì–´ë¦¬ ì •ë ¬ ì‹œìž‘ì  ê³„ì‚°]
        let distStartX = xPos;
        if (textAlign === 'center') distStartX = xPos - (totalDistWidth / 2);
        else if (textAlign === 'right') distStartX = xPos - totalDistWidth;

        // [ìˆ«ìžì™€ km ê·¸ë¦¬ê¸°]
        ctx.textAlign = "left"; 
        ctx.fillStyle = "white";
        ctx.font = `bold 180px ${font}`;
        ctx.fillText(dText, distStartX, startY);
        ctx.font = `600 60px ${font}`;
        ctx.fillText(unitText, distStartX + dWidth + spacing, startY);

        // 4. íŽ˜ì´ìŠ¤ & ì‹œê°„ ì„¹ì…˜ ì²˜ë¦¬
        const pace = formatPace(document.getElementById('paceInput').value);
        const time = formatTime(document.getElementById('timeInput').value);
        
        ctx.textAlign = textAlign; // ê° í•­ëª©ë³„ ì œìžë¦¬ ì •ë ¬ ì ìš©

        // í‰ê·  íŽ˜ì´ìŠ¤
        ctx.font = `500 40px ${font}`;
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        ctx.fillText("Avg. Pace", xPos, startY + 100);
        ctx.fillStyle = "white";
        ctx.font = `bold 75px ${font}`;
        ctx.fillText(pace, xPos, startY + 185);

        // ì‹œê°„
        ctx.font = `500 40px ${font}`;
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        ctx.fillText("Time", xPos, startY + 285);
        ctx.fillStyle = "white";
        ctx.font = `bold 75px ${font}`;
        ctx.fillText(time, xPos, startY + 370);
    }
    // [ì´ì „ê³¼ ë™ì¼í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ë“¤...]
    document.getElementById('paceInput').oninput = () => draw(displayData.distance);
    document.getElementById('timeInput').oninput = () => draw(displayData.distance);
    document.getElementById('distInput').oninput = (e) => { displayData.distance = parseFloat(e.target.value) || 0; draw(displayData.distance); };
    document.getElementById('imageInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => { const img = new Image(); img.onload = () => { bgImage = img; draw(displayData.distance); }; img.src = ev.target.result; };
        reader.readAsDataURL(e.target.files[0]);
    };

    async function runAnimation(isRecord = false) {
        const target = parseFloat(document.getElementById('distInput').value) || 0;
        const status = document.getElementById('status');
        const pBtn = document.getElementById('previewBtn');
        const rBtn = document.getElementById('recordBtn');
        displayData.distance = 0;
        pBtn.disabled = true; rBtn.disabled = true;

        let recorder = null; let chunks = [];
        if (isRecord) {
            status.innerText = "ðŸŽ¬ Recording...";
            const stream = canvas.captureStream(30);
            let options = { mimeType: 'video/mp4' };
            if (!MediaRecorder.isTypeSupported('video/mp4')) options = { mimeType: 'video/webm' };
            recorder = new MediaRecorder(stream, options);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: options.mimeType });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `run_${new Date().getTime()}.mp4`;
                a.click();
                status.innerText = "âœ… Saved!";
                pBtn.disabled = false; rBtn.disabled = false;
            };
            recorder.start();
        }

        gsap.to(displayData, {
            distance: target, duration: 5.5, ease: "power4.out",
            onUpdate: () => draw(displayData.distance),
            onComplete: () => { setTimeout(() => { if (isRecord) recorder.stop(); else { status.innerText = ""; pBtn.disabled = false; rBtn.disabled = false; } }, 1000); }
        });
    }
    draw();
</script>
</body>
</html>
