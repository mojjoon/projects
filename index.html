<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>준현의 러닝 레코드</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        /* 기존 디자인 유지 */
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        #video-container { position: relative; width: 100vw; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; bottom: 50px; left: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .stat { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .label { font-size: 1rem; opacity: 0.8; }
        #controls { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        button { background: rgba(255,255,255,0.2); border: 1px solid #fff; color: #fff; padding: 10px; border-radius: 8px; backdrop-filter: blur(5px); }
        .recording { background: red; border-color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="video-container">
    <video id="preview" autoplay playsinline muted></video>
    
    <div class="overlay">
        <div class="stat" id="display-pace">0'00"</div>
        <div class="label">평균 페이스 (km)</div>
        <div style="height: 20px;"></div>
        <div class="stat" id="display-dist">0.00</div>
        <div class="label">거리 (km)</div>
    </div>

    <div id="controls">
        <button id="btn-record">녹화 시작</button>
    </div>
</div>

<script>
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;

    // 카메라 연결
    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, 
            audio: true 
        });
        document.getElementById('preview').srcObject = stream;
        window.stream = stream;
    }

    // 아이폰용 .mp4 녹화 설정
    const startRecording = () => {
        recordedChunks = [];
        
        // 아이폰 사파리가 가장 선호하는 mp4 형식 지정
        let options = { mimeType: 'video/mp4' };
        if (!MediaRecorder.isTypeSupported('video/mp4')) {
            options = { mimeType: 'video/webm' }; // 안되면 차선책
        }

        mediaRecorder = new MediaRecorder(window.stream, options);
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: options.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Run_Record_${new Date().getTime()}.mp4`; // .mp4로 저장
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        };

        mediaRecorder.start();
        isRecording = true;
        document.getElementById('btn-record').innerText = "녹화 중지";
        document.getElementById('btn-record').classList.add('recording');
    };

    const stopRecording = () => {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('btn-record').innerText = "녹화 시작";
        document.getElementById('btn-record').classList.remove('recording');
    };

    document.getElementById('btn-record').onclick = () => {
        if (!isRecording) startRecording();
        else stopRecording();
    };

    // 데이터 표시 (준현님의 최근 기록 반영)
    document.getElementById('display-pace').innerText = "4'47\""; // 최근 8km 페이스
    document.getElementById('display-dist').innerText = "8.00";

    setupCamera();
</script>
</body>
</html>
